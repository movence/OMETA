var _html={tr:'<tr id="$trid$" class="borderBottom">$tds$</tr>',odo:'<td><input type="text" name="beanList[$cnt$].options" id="options$cnt$" size="27"/></td><td><textarea name="beanList[$cnt$].desc" id="desc$cnt$" cols="27" rows="1"/></td><td><input type="text" name="beanList[$cnt$].valueLength" id="valueLength$cnt$" size="10"/></td><td><input type="text" name="beanList[$cnt$].ontology" id="ontology$cnt$"  placeholder="Search Ontology"/></td>',lar:'<td><input type="text" name="beanList[$cnt$].label" id="label$cnt$" size="15"/></td><td class="comboBoxCB"><input type="checkbox" name="beanList[$cnt$].active" id="active$cnt$"/><td class="comboBoxCB"><input type="checkbox" name="beanList[$cnt$].required" id="required$cnt$"/>',s:'<td class="comboBoxCB"><input type="checkbox" name="beanList[$cnt$].sampleRequired" id="sampleRequired$cnt$"/>',pso:'<td class="comboBoxCB"><input type="checkbox" name="beanList[$cnt$].projectMeta" id="projectMeta$cnt$"/><td class="comboBoxCB"><input type="checkbox" name="beanList[$cnt$].sampleMeta" id="sampleMeta$cnt$"/><td><input type="text" name="beanList[$cnt$].order" id="order$cnt$" size="2"/></td>',ma:'<td class="fix172"><select name="beanList[$cnt$].name" id="ma$cnt$">$o$</select></td>',ema:'<td id="etTD$cnt$" class="fix172">$etTD$</td><td class="fix172">  <select name="beanList[$cnt$].name" id="ema$cnt$">$ema$</select></td>',etTD_c:'<div><table cellpadding="0" cellspacing="0">  <tr><td class="etTD_c" style="text-align:left;float:left;"><strong>$et$</strong></td></tr></table><div class="btn-xs btn-warning" style="max-width:60%;" title="Add attribute to the event group" id="add_$imgid$">Add Attribute</div></div>',etSelect:'<select name="beanList[$cnt$].et" id="et$cnt$">$et_opts$</select>',etHidden:'<input type="hidden" name="beanList[$cnt$].et" id="et$cnt$" value="$et$">'};var _utils={ontology:function(){window.open("http://bioportal.bioontology.org/search?opt=advanced","ontologyWindow","scrollbars=yes,toolbar=no,resizable=yes,width=800,height=600,left=50,top=50");return},flip:function(a,b){$(".panelHeader").html(a+" Metadata Setup");$('div[id$="MADiv"]').hide();console.log(b)},makeAjax:function(d,c,b,a){$.ajax({url:"metadataSetupAjax.action",cache:false,async:true,data:"type="+d+"&projectId="+parseInt(c)+"&eventName="+b,success:function(e){if(e.dataMap.errorMsg){var f=e.dataMap.errorMsg;if(f.indexOf("Forbidden")>0){f=utils.error.message.permission}utils.error.add(f)}else{a(e);$("#EMADiv").show();if($("#error_messages").get(0)){utils.error.remove()}}_utils.loading.hide()},fail:function(e){utils.error.add("Ajax Process has Failed.")},complete:function(){}})},callback:{all:function(b){var c=_utils.render;var a=b.dataMap;if(a&&a.et&&a.a&&a.pet){c.et(a.et);c.at(a.a);c.pet(a.pet)}if(!a.ema){_utils.loading.hide()}},ema:function(a){if(a.dataMap){_utils.render.ema(a.dataMap.ema)}}},render:{ema:function(a){if(a){$.each(a,function(c,b){_utils.add.ema(null,b.ema.eventName,b.ema.attributeName,b.ema.activeDB,b.ema.requiredDB,b.ema.sampleRequiredDB,b.ema.options,b.ema.desc,b.ema.label,b.ema.ontology,b.projectMeta,b.sampleMeta,b.ema.order)})}$('input:button[id$="AddButton"]').prop("disabled",false);_utils.loading.hide()},ema_d:function(b){var a=null;maOptions=vs.vnoption.replace("$v$",0).replace("$n$","");$.each(b.dynamicList,function(c,d){d=d.ema;if(c===0){a=""+d.projectId}if(d!=null&&d.attributeName!=null){maOptions+=vs.vvoption.replace(/\$v\$/g,d.attributeName);emaDict[d.attributeName]={a:d.activeDB,r:d.requiredDB,o:d.options,d:d.desc,l:d.label}}});_utils.makeAjax(type==="s"?"g_sma":"g_pma",a,null,_utils.callback.ma)},ma:function(a){$.each(a,function(b,c){if(c&&c.attributeName){_utils.add.ma(null,type==="s"?"smaAdditionTbody":"pmaAdditionTbody",c.attributeName,c.activeDB,c.requiredDB,c.options,c.desc,c.label,c.ontology)}});_utils.loading.hide()},et:function(a){if(a){$.each(a,function(b,c){if(c!=null&&c.name!=null){etOptions+=vs.vvoption.replace(/\$v\$/g,c.name)}})}},at:function(a){if(a){maOptions=vs.vnoption.replace("$v$",0).replace("$n$","");$.each(a,function(b,c){if(c!=null&&c.name!=null){maOptions+=vs.vvoption.replace(/\$v\$/g,c.name)}})}},pet:function(b){if(b){var a=vs.alloption;$.each(b,function(c,d){if(d!=null&&d.name!=null){a+=vs.vvoption.replace(/\$v\$/g,d.name)}});$("#_eventSelect").html(a);if(b[0]){comboBoxChanged({value:b[0].name},"_eventSelect");utils.preSelect("_eventSelect",b[0].name)}}}},add:{ma:function(j,c,f,k,b,e,i,g,h){$("#"+c).append($(_html.tr.replace(/\$tds\$/,_html.ma+_html.lar+_html.odo).replace(/\$trid\$/,"").replace(/\$cnt\$/g,maCnt).replace("$o$",maOptions)).toggleClass((j?"buttonAdded":"")));utils.combonize(c,"ma"+maCnt);utils.preSelect("ma"+maCnt,f);this.setValues(k,b,e,i,g,h)},ema:function(f,y,p,z,j,i,m,x,t,g,v,w,e){var A=this,h=y?y:"",b=h.split(" ").join(""),u=$("#etAdditionTbody"),k=u.find('tr[id*="'+h+'"]:last'),q=$(_html.tr.replace(/\$trid\$/,"tr_$et$_$cnt$").replace(/\$tds\$/,(h===""?"":_html.etHidden)+_html.ema.replace(/\$etTD\$/,(h===""?_html.etSelect.replace(/\$et_opts\$/,etOptions):_html.etTD_c.replace(/\$imgid\$/,b+"_$cnt$")))+_html.lar+_html.s+_html.odo+_html.pso).replace(/\$et\$/g,h).replace(/\$cnt\$/g,maCnt).replace("$ema$",maOptions));f?q.toggleClass("buttonAdded"):null;(k&&k.length>0)?k.after(q):u.append(q);var c=$("#etTD"+maCnt);c.parent("tr").prevAll('tr[id*="'+y+'"]').each(function(l,d){var a=$(d).find('td:first[id^="etTD"]'),n=a.attr("rowspan");if(a&&a.find(".etTD_c").text()===y){c.remove();a.attr("rowspan",(n?parseInt(n)+1:2))}});$("#add_"+b+"_"+maCnt).click(function(){A.ema("add",y)});utils.combonize("etAdditionTbody",maCnt);utils.preSelect("ema"+maCnt,p);utils.checkCB("sampleRequired"+maCnt,i);utils.checkCB("projectMeta"+maCnt,v);utils.checkCB("sampleMeta"+maCnt,w);this.setValues(z,j,m,x,t,g,e)},setValues:function(c,f,h,g,b,e,i){utils.checkCB("active"+maCnt,c);utils.checkCB("required"+maCnt,f);$("#options"+maCnt).val(h);$("#desc"+maCnt).val(g);$("#label"+maCnt).val(b);$("#order"+maCnt).val(i);$("#ontology"+maCnt).val(e).autocomplete({source:function(d,a){$.ajax({url:"ontologyAjax.action?t=sall",data:{maxRows:12,sw:d.term.replace(" ","%20")},success:function(j){if(!j||!j.result){utils.error.remove();$('input[id^="ontology"]').removeClass("ui-autocomplete-loading").removeAttr("style");utils.error.add("Ontolo	gy search failed. Please try again.")}else{a($.map(j.result,function(k){if(k.ontology){return{label:k.tlabel+" - "+k.ontolabel,value:k.tlabel,ontologyId:k.ontology,ontologyLabel:k.ontolabel,accession:k.taccession,term:k.tlabel}}else{return{label:k,value:"",ontology:null,term:null}}}))}}})},minLength:3,select:function(a,d){$(this).parent("td").prev("td").find("textarea:first-child").val(function(k,j){return(j==null?"":j.indexOf("[")>=0?j.substring(0,j.indexOf("[")):j+" ")+(d.item.accession?"["+d.item.accession+","+d.item.ontologyLabel+"]":"")})}}).css("width","100px");maCnt++}},popup:{open:function(b,a){$.openPopupLayer({name:b,width:450,url:a})},attribute:function(a){this.open("LPopupAddLookupValue","addLookupValue.action?type="+a)},dictionary:function(){this.open("LPopupAddDictionary","addDictionary.action")},ontology:function(){this.open("LPopupOntologySearch","ontologySearch.action")}},clean:{attribute:function(){$("tbody#etAdditionTbody, tbody#smaAdditionTbody, tbody#pmaAdditionTbody").html("");maCnt=0},all:function(){$('input:button[id$="AddButton"]').prop("disabled",true);$("#_projectSelect, #_eventSelect").val(0);utils.preSelect("_projectSelect");maOptions=null;etOptions=null;emaDict={};this.attribute();$("#EMADiv").hide()}},loading:{show:function(){$("#loadingImg").show()},hide:function(){$("#loadingImg").hide()}},submit:function(){$("form").submit()}};function refreshData(){_utils.loading.show();var a=$("#_projectSelect").val();if(a!="0"){_utils.makeAjax("g_all",a,null,_utils.callback.all)}else{utils.error.add("Please select a project!");_utils.loading.hide()}}function comboBoxChanged(d,f){var b;var a=_utils.callback;if(f==="_projectSelect"){_utils.loading.show();if(d.value!=null&&d.value!=0&&d.text!=null&&d.text!=""){_utils.clean.all();if(type==="s"||type==="p"){_utils.makeAjax("g_ema",d.value,null,a.ema_d)}else{etOptions=vs.vnoption.replace("$v$",0).replace("$n$","Select Event");_utils.makeAjax("g_all",d.value,null,a.all)}}else{return}}else{if(f==="_eventSelect"){_utils.loading.show();_utils.clean.attribute();_utils.makeAjax("g_ema",$("#_projectSelect option:selected").val(),d.value,a.ema)}else{if(f!=null&&f.indexOf("ma")!=-1){var c=f.substring(2),e;if(emaDict&&((e=emaDict[d.value])!=null)){utils.checkCB("active"+c,e.a);utils.checkCB("required"+c,e.r);$("#options"+c).val(e.o);$("#desc"+c).val(e.d);$("#label"+c).val(e.l)}}}}};